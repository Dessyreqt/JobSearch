# JobSearch

This is the JobSearch template, the project from which future API projects should be created.

## Build requirements

To run this API fully locally, you will likely need to be running Windows as the database is set up to use SQL Server. However if you can connect to a separate SQL Server, you should be able to use any platform. To get your environment setup install the following:

- [.NET Core 3.0 SDK](https://dotnet.microsoft.com/download/dotnet-core/3.0)
- [SQL Server 2017 Express Edition](https://www.microsoft.com/en-us/sql-server/sql-server-editions-express) - Only if you feel the need to run your database locally

To build the JobSearch, simply run the build.bat file in the root of the repository.

## Code Quality & Style

Code Quality and Style are enforced by a set of analyzer packages that run when the build happens. Additionally, all warnings are treated by default as errors. This is is to make sure clean code is committed to the repository at all times.

## Data Structure

The data structure for JobSearch by default only contains a set of tables to manage the Identity of users that access the API.

The database is managed by RoundhousE, a database migration solution that runs prior to building the application.

## Request Processing

By default, requests go through the following steps:
- Validation (automatic for POST requests from body)
- Start Performance Tracking
- Handling
- Log Performance Data
- Exception Handling (if needed)

The response will include the response object in the body. If there were no errors, a 200 is returned. If there are only validation errors, a 400 is returned with a list of errors as follows:

```JSON
{
    "errors": [
        {
            "message": "'Id' must be less than '10'."
        },
        {
            "message": "'Id' must be less than '100'."
        }
    ]
}
```

If there is an internal server error, a 500 will be returned with a response similar to the following:

```JSON
{
    "errors": [
        {
            "message": "An internal error occurred with ID 3998103b-3542-411d-a481-a607765428b5"
        }
    ]
}
```

And in the logs, an entry similar to the following will be generated:

```
2018-12-03 12:42:42.515 -06:00 [Error] Exception ID: 3998103b-3542-411d-a481-a607765428b5 Exception: "System.Exception: Backend error details go here...
   at JobSearch.Features.Values.ValuesController.GetValue(Int32 id) in C:\github\Dessyreqt\JobSearch\JobSearch\Features\Values\ValuesController.cs:line 29
   at lambda_method(Closure , Object , Object[] )
   at Microsoft.Extensions.Internal.ObjectMethodExecutor.Execute(Object target, Object[] parameters)
   at Microsoft.AspNetCore.Mvc.Internal.ActionMethodExecutor.SyncActionResultExecutor.Execute(IActionResultTypeMapper mapper, ObjectMethodExecutor executor, Object controller, Object[] arguments)
   at Microsoft.AspNetCore.Mvc.Internal.ControllerActionInvoker.InvokeActionMethodAsync()
   at Microsoft.AspNetCore.Mvc.Internal.ControllerActionInvoker.InvokeNextActionFilterAsync()
   at Microsoft.AspNetCore.Mvc.Internal.ControllerActionInvoker.Rethrow(ActionExecutedContext context)
   at Microsoft.AspNetCore.Mvc.Internal.ControllerActionInvoker.Next(State& next, Scope& scope, Object& state, Boolean& isCompleted)
   at Microsoft.AspNetCore.Mvc.Internal.ControllerActionInvoker.InvokeInnerFilterAsync()
   at Microsoft.AspNetCore.Mvc.Internal.ResourceInvoker.InvokeNextExceptionFilterAsync()"
```

By default logs are placed in %LOCALAPPDATA%\JobSearch\logs.

## Health checks

At any point, the health of the API may be checked by navigating to {{ApiUrl}}/healthcheck. This will return a status of either "Healthy", "Degraded", or "Unhealthy" for itself and its dependencies. If all is well, the following response will be returned:

```JSON
{
    "status": "Healthy",
    "errors": [
        {
            "key": "Sql Server",
            "value": "Healthy"
        },
        {
            "key": "Sendgrid API",
            "value": "Healthy"
        }
    ]
}
```

## Automated Testing

Currently the project doesn't have full code coverage, but automated testing facilities are in place. There are integration tests on the backend powered by the Fixie framework. This allows for unit tests to be created with minimal ceremony (no need for attributes to specify whether a class is a test class, or a method is a test method.) Building the solution will discover the tests, and they can be run from the Test Explorer.

Additionally tests will be run as part of the build process if the `build` script is being used.

The tests will also run as part of the CICD process.

A code coverage report can be generated by running `build coverage` from the root of the repository.

### Creating an automated test

Automated tests should be placed to match the corresponding handler they are testing. For example, if the handler you are testing is located at `JobSearch/Features/Users/Actions/Register`, then your tests should be placed in `JobSearch.Tests/Features/Users/Actions/Register`. The test class should start with `When` to identify the scenario you are testing. The test methods should all be `public void` methods. Other methods will not be detected as test methods and will not be run by the test runner.

NOTE: if you have an `appsettings.local.json` defined for the main project, you should have one defined for the test project as well.

When a test class runs, the class constructor is called once, and then each test method is called. Thus you should structure your tests as follows:

```C#
public class WhenTestingAHandler
{
    public WhenTestingAHandler()
    {
        // Assemble

        // Act
    }

    public void ShouldAssertSomething()
    {
        // Assert
    }

    public void ShouldAssertSomethingElse()
    {
        // Assert
    }
}
```

## Swagger

Swagger exists to let frontend developers know about the schema, what APIs exist, and specify the expected requests and responses. There is built in swagger support and the swagger documentation can be found at {{ApiUrl}}/swagger. This documentation can also be used by frontend developers to automate building some of their code.

Swagger is maintained by coding very purposefully. Controller methods should be commented using xmldoc comments (`///` comments.) These comments will turn into descriptions in the swagger page. Controller methods should also be named appropriately. Check `ApiResponseConventions.cs` for details on what the current conventions are.

## User Workflows

### User Creation

In order to create a user, first send the following payload to {{ApiUrl}}/api/users/actions/register:

```JSON
{
    "email": "user@dscarroll.com",
    "password": "password",
    "confirmPassword": "password"
}
```

This will add the user to the database and send a confirmation email to that user. Email confirmation is required for any of the APIs that require authentication. The Email Confirmation URL should be set in the appsettings.json file under the key `"User:EmailConfirmationUrl"`.

The confirmation email link will include the user's ID and a token that will allow the user to confirm his email.

When the user clicks the link in the email that is sent, they should be sent to a landing page where a similar payload to the following should be sent to {{ApiUrl}}/api/users/actions/confirmEmail:

```JSON
{
    "userId": "1",
    "code": "CfDJ8IVl0qKbmYhJpVzns7ZjiTs1e1X/QDMYoK5XVXtDCIWyZdRkpM/Dz2lxMtULAKOZ2Ut9PJum+ED6wIPslTOx52O4lf8APzikuFeB1mSdCKwVlV6r6UuwAHCTyfP+2jct4sE0LQtGxAERYfbbVmcvH4V+kvJc+PWsVwfi6dhRB20B5u+NuMvtsDVzHz2SW5xjuQ=="
}
```

This will confirm the user's email in the database and allow them to use features blocked by authorization.

### Login

To login a user, send this payload to {{ApiUrl}}/api/users/actions/login:

```JSON
{
    "email": "user@dscarroll.com",
    "password": "password"
}
```

If the login is valid, a response similar to the following is returned:

```JSON
{
    "requiresTwoFactor": false,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJkY2Fycm9sbCs2QHJ1bWJsZW9uLmNvbSIsImp0aSI6IjQ4YWRkMDU2LTYyNDMtNDJiZi1hYWUyLTM2NzE0OTViMTEzZCIsImh0dHA6Ly9zY2hlbWFzLnhtbHNvYXAub3JnL3dzLzIwMDUvMDUvaWRlbnRpdHkvY2xhaW1zL25hbWVpZGVudGlmaWVyIjoiNyIsImV4cCI6MTU0NjcxMTA2MywiaXNzIjoiaHR0cDovL2xvY2FsaG9dzDoxNDM1NiIsImF1ZCI6Imh0dHA6Ly9sb2NhbGhvc3Q6MTQzNTYifQ.LPnURRv2fKSG5qC6HNKWAov0uO6gma0ESHyg94o1s5I"
}
```

Two-factor authentication is not implmented at the moment. When it is implemented and the user requires two-factor authentication, the token will not be present.

This token is a JWT which needs to be passed in using the Bearer authentication scheme for future API requests. The default expiration on this token is a day; this can be configured in the appsettings.json file under the key `"Jwt:ExpireDays"`.

### Forgot Password

If the user forgets their password, this can be accommodated by send the following payload to {{ApiUrl}}/api/users/actions/forgotPassword:

```JSON
{
    "email": "user@dscarroll.com"
}
```

This will return an empty response to the frontend, but will also send an email to the user with additional instructions. There will be a link with a code that should direct the user to a landing page where they can reset the password. This page should be defined in the appsettings.json file under the key `"User:ResetPasswordUrl"`.

NOTE: For security reasons, this API will not let the user know if there is actually an account with that email address. It will return a 200 OK response regardless.

The following payload should be sent from the Reset Password page to {{ApiUrl}}/api/users/actions/resetPassword:

```JSON
{
    "email": "user@dscarroll.com",
    "password": "newpassword",
    "confirmPassword": "newpassword",
    "code": "CfDJ8KFS5bIr/SpLgvWT4DV8KEzq+ZF8UnWtKE8X463m1efacGw12JYqV1owDrE5Tbf3DizPvf8h4YFgMKAT6WAbb7dfHMP1+XoXjcAwWEUzSnrThV/62aOo+B6cjHO2JziwVOZqhpeIlW7bYCVnKEnEoQTpoXSXNqn/D8txxdAuaYn5BCJwoWAbN+N10aSWgF+idg=="
}
```

### Change Password

Changing the password requires authorization, and the UserId is already stored in the JWT. Thus, the only information that needs to be sent to {{ApiUrl}}/api/users/actions/changePassword is:

```JSON
{
    "oldPassword": "password",
    "newPassword": "newpassword",
    "confirmPassword": "newpassword"
}
```

If the oldPassword is the correct password for that user, the password will be changed to the newPassword.
